import { readFile as p, writeFile as u } from "node:fs/promises";
import { basename as $, extname as O } from "node:path";
import { styleText as r, promisify as k } from "node:util";
import x from "sade";
import E from "strip-json-comments";
import { createRequire as N } from "node:module";
import v from "@jsonresume/schema";
const C = "../package.json", d = JSON.parse(
  await p(new URL(C, import.meta.url), "utf-8")
), c = "resume.json", w = (e, t) => [$(e, O(e)), t].join("."), h = async (e) => JSON.parse(E(await p(e, "utf-8"))), y = async (e, t) => {
  const o = t ?? e?.meta?.theme;
  if (!o)
    throw new Error(
      `No theme to use. Please specify one via the ${r("yellow", "--theme")} option or the ${r("yellow", ".meta.theme")} field of your resume.`
    );
  try {
    return await import(o);
  } catch {
    throw new Error(
      `Could not load theme ${r("yellow", o)}. Is it installed?`
    );
  }
}, l = x(d.name).version(d.version);
l.command("render [filename]", "Render resume", { default: !0 }).option("-o, --output", "Output filename").option("-t, --theme", "Theme to use").action(
  async (e = c, {
    output: t = w(
      e,
      "html"
      /* Html */
    ),
    theme: o
  }) => {
    const a = await h(e), n = await y(a, o), s = await f(a, n);
    await u(t, s), console.log(
      `You can find your rendered resume at ${r("yellow", t)}. Nice work! ðŸš€`
    );
  }
);
l.command("export [filename]", "Export resume to PDF").option("-o, --output", "Output filename").option("-t, --theme", "Theme to use").option("--puppeteer-arg", "Puppeteer launch argument").action(
  async (e = c, {
    output: t = w(
      e,
      "pdf"
      /* Pdf */
    ),
    theme: o,
    ...a
  }) => {
    const n = await h(e), s = await y(n, o), i = await f(n, s), m = await T(i, n, s, {
      args: [a["puppeteer-arg"] ?? []].flat()
    });
    await u(t, m), console.log(
      `You can find your exported resume at ${r("yellow", t)}. Nice work! ðŸš€`
    );
  }
);
l.command("init [filename]", "Create sample resume", { alias: "create" }).action(async (e = c) => {
  await R(e), console.log(
    `Done! Start editing ${r("yellow", e)} now, and run the ${r("yellow", "render")} command when you are ready. ðŸ‘`
  );
});
l.command("validate [filename]", "Validate resume").action(async (e = c) => {
  try {
    await J(e), console.log(`Your ${r("yellow", e)} looks amazing! âœ¨`);
  } catch (t) {
    if (!Array.isArray(t))
      throw t;
    console.error(
      `Uh-oh! The following errors were found in ${r("yellow", e)}:
`
    ), t.forEach(
      (o) => console.error(
        ` ${r("red", `âŒ ${o.message}`)} at ${r("yellow", o.path)}.`
      )
    ), process.exitCode = 1;
  }
});
const F = N(import.meta.url), R = (e) => {
  const t = F("@jsonresume/schema/sample.resume.json");
  return u(e, JSON.stringify(t, void 0, 2));
}, T = async (e, t, o, { moduleName: a = "puppeteer", args: n = [] } = {}) => {
  let s;
  try {
    s = await import(a);
  } catch {
    throw new Error(
      `Could not import ${r("yellow", a)} package. Is it installed?`
    );
  }
  const i = await s.launch({ args: n }), m = await i.newPage();
  await m.setContent(e, { waitUntil: "networkidle0" });
  const g = await m.pdf({
    ...o.pdfRenderOptions,
    ...t.meta?.pdfRenderOptions
  });
  return await i.close(), g;
}, f = (e, t) => t.render(e), j = k(v.validate), J = async (e) => {
  const t = await p(e, "utf-8");
  return j(JSON.parse(t));
};
export {
  l as cli,
  R as init,
  T as pdf,
  f as render,
  J as validate
};
